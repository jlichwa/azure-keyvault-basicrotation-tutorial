{  
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{  
     "ResourceNamePrefix":{  
        "defaultValue":"[resourceGroup().name]",
        "type":"string",
        "metadata":{  
           "description":"Prefix for resource names."
        }
     }
  },
  "variables":{  
     "storageaccountid":"[concat(resourceGroup().id,'/providers/','Microsoft.Storage/storageAccounts/', parameters('ResourceNamePrefix'),'strg')]"
  },
  "resources":[  
     {  
        "type":"Microsoft.Sql/servers",
        "apiVersion":"2015-05-01-preview",
        "name":"[concat(parameters('ResourceNamePrefix'),'-sql')]",
        "location":"[resourceGroup().location]",
        "kind":"v12.0",
        "properties":{  
           "administratorLogin":"azureuser",
           "administratorLoginPassword":"Simple123",
           "version":"12.0"
        }
     },
     {  
        "type":"Microsoft.Sql/servers/firewallRules",
        "apiVersion":"2015-05-01-preview",
        "name":"[concat(parameters('ResourceNamePrefix'),'-sql', '/AllowAllWindowsAzureIps')]",
        "dependsOn":[  
           "[resourceId('Microsoft.Sql/servers', concat(parameters('ResourceNamePrefix'),'-sql'))]"
        ],
        "properties":{  
           "startIpAddress":"0.0.0.0",
           "endIpAddress":"0.0.0.0"
        }
     },
     {  
        "type":"Microsoft.Storage/storageAccounts",
        "apiVersion":"2019-04-01",
        "name":"[concat(parameters('ResourceNamePrefix'),'strg')]",
        "location":"[resourceGroup().location]",
        "sku":{  
           "name":"Standard_LRS",
           "tier":"Standard"
        },
        "kind":"Storage",
        "properties":{  
           "networkAcls":{  
              "bypass":"AzureServices",
              "virtualNetworkRules":[  

              ],
              "ipRules":[  

              ],
              "defaultAction":"Allow"
           },
           "supportsHttpsTrafficOnly":true,
           "encryption":{  
              "services":{  
                 "file":{  
                    "enabled":true
                 },
                 "blob":{  
                    "enabled":true
                 }
              },
              "keySource":"Microsoft.Storage"
           }
        }
     },
     {  
        "type":"Microsoft.Web/serverfarms",
        "apiVersion":"2018-02-01",
        "name":"[concat(parameters('ResourceNamePrefix'),'-plan')]",
        "location":"[resourceGroup().location]",
        "sku":{  
           "name":"S1",
           "tier":"Standard",
           "size":"S1",
           "family":"S",
           "capacity":1
        },
        "kind":"app",
        "properties":{  
           "perSiteScaling":false,
           "maximumElasticWorkerCount":1,
           "isSpot":false,
           "reserved":false,
           "isXenon":false,
           "hyperV":false,
           "targetWorkerCount":0,
           "targetWorkerSizeId":0
        }
     },
     {  
        "type":"Microsoft.Web/sites",
        "apiVersion":"2018-11-01",
        "name":"[concat(parameters('ResourceNamePrefix'),'-app')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.Web/serverfarms', concat(parameters('ResourceNamePrefix'),'-plan'))]"
        ],
        "kind":"app",
        "identity":{  
           "type":"SystemAssigned"
        },
        "properties":{  
           "enabled":true,
           "hostNameSslStates":[  
              {  
                 "name":"[concat(parameters('ResourceNamePrefix'),'-app', '.azurewebsites.net')]",
                 "sslState":"Disabled",
                 "hostType":"Standard"
              },
              {  
                 "name":"[concat(parameters('ResourceNamePrefix'),'-app', '.scm.azurewebsites.net')]",
                 "sslState":"Disabled",
                 "hostType":"Repository"
              }
           ],
           "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', concat(parameters('ResourceNamePrefix'),'-plan'))]",
           "reserved":false,
           "isXenon":false,
           "hyperV":false,
           "scmSiteAlsoStopped":false,
           "clientAffinityEnabled":true,
           "clientCertEnabled":false,
           "hostNamesDisabled":false,
           "containerSize":0,
           "dailyMemoryTimeQuota":0,
           "httpsOnly":false,
           "redundancyMode":"None",
           "siteConfig":{  
              "appSettings":[  
                 {  
                    "name":"DataSource",
                    "value":"[concat(parameters('ResourceNamePrefix'),'-sql','.database.windows.net')]"
                 },
                 {  
                    "name":"KeyVaultName",
                    "value":"[concat(parameters('ResourceNamePrefix'),'-kv')]"
                 }
              ]
           }
        }
     },
     {  
        "type":"Microsoft.Web/sites",
        "apiVersion":"2018-11-01",
        "name":"[concat(parameters('ResourceNamePrefix'),'-fn')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.Web/serverfarms', concat(parameters('ResourceNamePrefix'),'-plan'))]"
        ],
        "kind":"functionapp",
        "identity":{  
           "type":"SystemAssigned"
        },
        "properties":{  
           "enabled":true,
           "hostNameSslStates":[  
              {  
                 "name":"[concat(parameters('ResourceNamePrefix'),'-fn', '.azurewebsites.net')]",
                 "sslState":"Disabled",
                 "hostType":"Standard"
              },
              {  
                 "name":"[concat(parameters('ResourceNamePrefix'),'-fn', '.scm.azurewebsites.net')]",
                 "sslState":"Disabled",
                 "hostType":"Repository"
              }
           ],
           "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', concat(parameters('ResourceNamePrefix'),'-plan'))]",
           "reserved":false,
           "isXenon":false,
           "hyperV":false,
           "scmSiteAlsoStopped":false,
           "clientAffinityEnabled":true,
           "clientCertEnabled":false,
           "hostNamesDisabled":false,
           "containerSize":1536,
           "dailyMemoryTimeQuota":0,
           "httpsOnly":false,
           "redundancyMode":"None",
           "siteConfig":{  
              "appSettings":[  
                 {  
                    "name":"AzureWebJobsStorage",
                    "value":"[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('ResourceNamePrefix'),'strg', ';AccountKey=', listKeys(variables('storageaccountid'),'2015-05-01-preview').key1)]"
                 },
                 {  
                    "name":"FUNCTIONS_EXTENSION_VERSION",
                    "value":"~3"
                 },
                 {  
                    "name":"FUNCTIONS_WORKER_RUNTIME",
                    "value":"dotnet"
                 }
              ]
           }
        }
     },
     {  
        "type":"Microsoft.Web/sites/config",
        "apiVersion":"2018-11-01",
        "name":"[concat(parameters('ResourceNamePrefix'),'-fn', '/web')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.Web/sites', concat(parameters('ResourceNamePrefix'),'-fn'))]"
        ],
        "properties":{  
           "numberOfWorkers":1,
           "defaultDocuments":[  
              "Default.htm",
              "Default.html",
              "Default.asp",
              "index.htm",
              "index.html",
              "iisstart.htm",
              "default.aspx",
              "index.php"
           ],
           "netFrameworkVersion":"v4.0",
           "phpVersion":"5.6",
           "pythonVersion":"",
           "nodeVersion":"",
           "linuxFxVersion":"",
           "requestTracingEnabled":false,
           "remoteDebuggingEnabled":false,
           "remoteDebuggingVersion":"VS2019",
           "httpLoggingEnabled":false,
           "logsDirectorySizeLimit":35,
           "detailedErrorLoggingEnabled":false,
           "publishingUsername":"$deploytest-fn",
           "scmType":"None",
           "use32BitWorkerProcess":true,
           "webSocketsEnabled":false,
           "alwaysOn":true,
           "appCommandLine":"",
           "managedPipelineMode":"Integrated",
           "virtualApplications":[  
              {  
                 "virtualPath":"/",
                 "physicalPath":"site\\wwwroot",
                 "preloadEnabled":true,
                 "virtualDirectories":null
              }
           ],
           "winAuthAdminState":0,
           "winAuthTenantState":0,
           "customAppPoolIdentityAdminState":false,
           "customAppPoolIdentityTenantState":false,
           "loadBalancing":"LeastRequests",
           "routingRules":[  

           ],
           "experiments":{  
              "rampUpRules":[  

              ]
           },
           "autoHealEnabled":false,
           "vnetName":"",
           "siteAuthEnabled":false,
           "siteAuthSettings":{  
              "enabled":null,
              "unauthenticatedClientAction":null,
              "tokenStoreEnabled":null,
              "allowedExternalRedirectUrls":null,
              "defaultProvider":null,
              "clientId":null,
              "clientSecret":null,
              "clientSecretCertificateThumbprint":null,
              "issuer":null,
              "allowedAudiences":null,
              "additionalLoginParams":null,
              "isAadAutoProvisioned":false,
              "googleClientId":null,
              "googleClientSecret":null,
              "googleOAuthScopes":null,
              "facebookAppId":null,
              "facebookAppSecret":null,
              "facebookOAuthScopes":null,
              "twitterConsumerKey":null,
              "twitterConsumerSecret":null,
              "microsoftAccountClientId":null,
              "microsoftAccountClientSecret":null,
              "microsoftAccountOAuthScopes":null
           },
           "cors":{  
              "allowedOrigins":[  
                 "https://functions.azure.com",
                 "https://functions-staging.azure.com",
                 "https://functions-next.azure.com"
              ],
              "supportCredentials":false
           },
           "localMySqlEnabled":false,
           "managedServiceIdentityId":6235,
           "ipSecurityRestrictions":[  
              {  
                 "ipAddress":"Any",
                 "action":"Allow",
                 "priority":1,
                 "name":"Allow all",
                 "description":"Allow all access"
              }
           ],
           "scmIpSecurityRestrictions":[  
              {  
                 "ipAddress":"Any",
                 "action":"Allow",
                 "priority":1,
                 "name":"Allow all",
                 "description":"Allow all access"
              }
           ],
           "scmIpSecurityRestrictionsUseMain":false,
           "http20Enabled":false,
           "minTlsVersion":"1.2",
           "ftpsState":"AllAllowed",
           "reservedInstanceCount":0,
           "fileChangeAuditEnabled":false,
           "functionsRuntimeScaleMonitoringEnabled":false
        }
     },
     {  
        "type":"Microsoft.KeyVault/vaults",
        "apiVersion":"2018-02-14",
        "name":"[concat(parameters('ResourceNamePrefix'),'-kv')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.Web/sites', concat(parameters('ResourceNamePrefix'),'-app'))]",
           "[resourceId('Microsoft.Web/sites', concat(parameters('ResourceNamePrefix'),'-fn'))]"
        ],
        "properties":{  
           "sku":{  
              "family":"A",
              "name":"Standard"
           },
           "tenantId":"[subscription().tenantId]",
           "accessPolicies":[  
              {  
                 "tenantId":"[subscription().tenantId]",
                 "objectId":"[reference(concat(resourceId('Microsoft.Web/sites', concat(parameters('ResourceNamePrefix'),'-app')),'/providers/Microsoft.ManagedIdentity/Identities/default'),'2015-08-31-PREVIEW').principalId]",
                 "permissions":{  
                    "keys":[  

                    ],
                    "secrets":[  
                       "Get",
                       "List"
                    ],
                    "certificates":[  

                    ]
                 }
              },
              {  
                 "tenantId":"[subscription().tenantId]",
                 "objectId":"[reference(concat(resourceId('Microsoft.Web/sites', concat(parameters('ResourceNamePrefix'),'-fn')),'/providers/Microsoft.ManagedIdentity/Identities/default'),'2015-08-31-PREVIEW').principalId]",
                 "permissions":{  
                    "keys":[  

                    ],
                    "secrets":[  
                       "Get",
                       "List",
                       "Set"
                    ],
                    "certificates":[  

                    ]
                 }
              }
           ],
           "enabledForDeployment":false,
           "enabledForDiskEncryption":false,
           "enabledForTemplateDeployment":false
        }
     },
     {  
        "type":"Microsoft.KeyVault/vaults/secrets",
        "apiVersion":"2016-10-01",
        "name":"[concat(parameters('ResourceNamePrefix'),'-kv', '/sqluser')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.KeyVault/vaults', concat(parameters('ResourceNamePrefix'),'-kv'))]"
        ],
        "tags":{  

        },
        "properties":{  
           "value":"Simple123"
        }
     }
  ]
}