{  
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{  
     "rgName":{  
        "defaultValue":"[rotationsample]",
        "type":"string",
        "metadata":{  
           "description":"Specifies the name of the resource groups, which is used as prefix for resource names."
        }
     }
  },
  "variables":{  
     "storageaccountid":"[concat(resourceGroup().id,'/providers/','Microsoft.Storage/storageAccounts/', parameters('rgName'),'strg')]"
  },
  "resources":[  
     {  
        "type":"Microsoft.Sql/servers",
        "apiVersion":"2015-05-01-preview",
        "name":"[concat(parameters('rgName'),'-sql')]",
        "location":"[resourceGroup().location]",
        "kind":"v12.0",
        "properties":{  
           "administratorLogin":"azureuser",
           "administratorLoginPassword":"Simple123",
           "version":"12.0"
        }
     },
     {  
        "type":"Microsoft.Sql/servers/firewallRules",
        "apiVersion":"2015-05-01-preview",
        "name":"[concat(parameters('rgName'),'-sql', '/AllowAllWindowsAzureIps')]",
        "dependsOn":[  
           "[resourceId('Microsoft.Sql/servers', concat(parameters('rgName'),'-sql'))]"
        ],
        "properties":{  
           "startIpAddress":"0.0.0.0",
           "endIpAddress":"0.0.0.0"
        }
     },
     {  
        "type":"Microsoft.KeyVault/vaults",
        "apiVersion":"2018-02-14",
        "name":"[concat(parameters('rgName'),'-kv')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.Web/sites', concat(parameters('rgName'),'-app'))]",
           "[resourceId('Microsoft.Web/sites', concat(parameters('rgName'),'-fn'))]"
        ],
        "properties":{  
           "sku":{  
              "family":"A",
              "name":"Standard"
           },
           "tenantId":"[subscription().tenantId]",
           "accessPolicies":[  
              {  
                 "tenantId":"[subscription().tenantId]",
                 "objectId":"[reference(concat(resourceId('Microsoft.Web/sites', concat(parameters('rgName'),'-app')),'/providers/Microsoft.ManagedIdentity/Identities/default'),'2015-08-31-PREVIEW').principalId]",
                 "permissions":{  
                    "keys":[  

                    ],
                    "secrets":[  
                       "Get",
                       "List"
                    ],
                    "certificates":[  

                    ]
                 }
              },
              {  
                 "tenantId":"[subscription().tenantId]",
                 "objectId":"[reference(concat(resourceId('Microsoft.Web/sites', concat(parameters('rgName'),'-fn')),'/providers/Microsoft.ManagedIdentity/Identities/default'),'2015-08-31-PREVIEW').principalId]",
                 "permissions":{  
                    "keys":[  

                    ],
                    "secrets":[  
                       "Get",
                       "List",
                       "Set"
                    ],
                    "certificates":[  

                    ]
                 }
              }
           ],
           "enabledForDeployment":false,
           "enabledForDiskEncryption":false,
           "enabledForTemplateDeployment":false
        }
     },
     {  
        "type":"Microsoft.KeyVault/vaults/secrets",
        "apiVersion":"2016-10-01",
        "name":"[concat(parameters('rgName'),'-kv', '/sqluser')]",
        "location":"[resourceGroup().location]",
        "dependsOn":[  
           "[resourceId('Microsoft.KeyVault/vaults', concat(parameters('rgName'),'-kv')]"
        ],
        "tags":{  

        },
        "properties":{  
           "value":"Simple123"
        }
     }
  ]
}